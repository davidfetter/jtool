#!/bin/bash

# Usage: jtool [OPTIONS] COMMAND

########################################################################
# Bash environment
########################################################################

# Safety
set -o errexit  \
    -o pipefail \
    -o nounset  \
    -o noclobber

# Extensions
set +o posix
shopt -s lastpipe
shopt -s expand_aliases
shopt -s extglob
shopt -s globstar

########################################################################
# Parse `jtool` options
########################################################################

alias print='echo 1>&2 -e'
alias message='cat 1>&2'

function fatal
{
    print "fatal: $@"
    exit 1
}

# getopts...

########################################################################
# Builtin commands
########################################################################

function command_help
{
    local cmd=$1

    $0-$cmd -\? | less
}

function command_pager
{
    # Arguments
    local filename=$1

    # `jq` options
    local -a JQ_OPT=(
        --indent 4 
        --color-output
    #   --compact-output    TODO: as parameter
    )

    # `less` options 
    local -a LESS_OPT=(
        --chop-long-lines
        --clear-screen
        --hilite-search
        --HILITE-UNREAD
        --ignore-case
        --LONG-PROMPT
        --no-init
        --quit-on-intr
        --RAW-CONTROL-CHARS
        --squeeze-blank-lines
        --status-column
    )

    # Paginate JSON!
    jq ${JQ_OPT[@]} . "${filename}" | less ${LESS_OPT[@]}
}

########################################################################
# Command
########################################################################

# Get command
declare COMMAND=${1?Expected command}
declare TOOL=$0-${COMMAND}
shift

case ${COMMAND} in
    help)
        (( $# == 1 )) || fatal 'Expected command name'
        case $1 in
            help) echo TODO ;;
            pager) exec less --help ;;
            *) command_help $1 ;;
        esac
        ;;
    pager)
        command_pager ${1:--}
        ;;
    *)
        if [[ -t 1 ]]; then
            ${TOOL} "$@" | command_pager -
        else
            ${TOOL} "$@"
        fi
esac

exit

# vim:syntax=sh:et:sw=4:ts=4:ai
